# Revue des classes

Ce document passe en revue chaque classe du plugin, regroupée par package, avec un rappel du rôle observé et des points d’attention ou d’optimisation rapides.

## Core / Plugin
- **PrestigeHoePlugin** — point d’entrée qui installe les ressources, configure le stockage, enregistre services/listeners/commandes et programme l’auto-save. La classe est très volumineuse et mélange bootstrap, wiring et logique de reload; à scinder en helpers (setupStorage, registerListeners/Commands, copyResources) pour limiter les responsabilités. 【F:src/main/java/fr/batistou15/prestigehoe/PrestigeHoePlugin.java†L38-L200】
- **ConfigManager** — centralise le rechargement des fichiers de configuration et expose les getters de sections; pourrait exposer une interface `Reloadable` pour harmoniser les recharges et limiter les doubles lectures. 【F:src/main/java/fr/batistou15/prestigehoe/config/ConfigManager.java†L14-L118】
- **FormulaEngine** — moteur de formules basé sur les configs pour calculer gains et coûts; ajouter des validations/guards sur les variables manquantes pour éviter les erreurs à l’exécution. 【F:src/main/java/fr/batistou15/prestigehoe/formula/FormulaEngine.java†L15-L161】

## Data / Stockage
- **DataStorage** — interface de persistance (load/save/flush). Envisager `CompletableFuture` pour clarifier l’asynchronicité. 【F:src/main/java/fr/batistou15/prestigehoe/data/DataStorage.java†L1-L15】
- **PlayerDataManager** — cache des profils et orchestration I/O; le `ConcurrentHashMap` protège les lectures, mais les écritures disque restent non sérialisées (risque de corruption en auto-save + quit). Un exécuteur sérialisé ou des verrous fichier aideraient. 【F:src/main/java/fr/batistou15/prestigehoe/data/PlayerDataManager.java†L20-L221】
- **PlayerProfile** — données complètes d’un joueur (hoe + statistiques). Pensez à documenter les champs dérivés (e.g., compteurs « earned ») pour éviter les oublis lors de la sérialisation. 【F:src/main/java/fr/batistou15/prestigehoe/data/PlayerProfile.java†L12-L199】
- **HoeData** — état de la houe (niveau/xp/prestige/skin/enchants). Les setters clampent les bornes, ce qui est bien; prévoir une méthode pour reset partiel afin de limiter les duplications dans les commandes admin. 【F:src/main/java/fr/batistou15/prestigehoe/data/HoeData.java†L5-L140】
- **JsonDataStorage** — persistance disque JSON par profil; les logs `INFO` à chaque sauvegarde peuvent spammer. Ajouter un verrou par fichier ou une queue d’écriture éviterait les corruptions concurrentes. 【F:src/main/java/fr/batistou15/prestigehoe/data/JsonDataStorage.java†L16-L166】
- **SqliteDataStorage** — stockage SQLite; la connexion est réouverte à la volée mais sans pool ni fermeture dans `onDisable`. Ajouter une fermeture explicite et un batch `saveAll` réduirait l’I/O. 【F:src/main/java/fr/batistou15/prestigehoe/data/SqliteDataStorage.java†L9-L146】
- **MysqlDataStorage** — stockage MySQL avec table `ph_players`; même remarque sur la fermeture et le pool (Hikari) pour fiabiliser. 【F:src/main/java/fr/batistou15/prestigehoe/data/MysqlDataStorage.java†L10-L155】

## Hooks / Integrations
- **EconomyHook** — encapsule Vault pour l’argent; vérifie la présence de Vault/Economy au démarrage. Gérer le cas de reload tardif (e.g., plugin economy chargé après) via un retry améliorera la robustesse. 【F:src/main/java/fr/batistou15/prestigehoe/hooks/EconomyHook.java†L9-L93】
- **JobsHook** — liaison optionnelle avec JobsReborn; note un flag debug. Centraliser les logs de succès/échec dans ConfigManager éviterait les divergences de messages. 【F:src/main/java/fr/batistou15/prestigehoe/hooks/JobsHook.java†L9-L75】

## Utilitaires
- **MessageUtil** — formatte les messages (colors, placeholders) et envoie aux joueurs. Attention aux concaténations répétées; StringBuilder ou composants Adventure éviteront le coût. 【F:src/main/java/fr/batistou15/prestigehoe/util/MessageUtil.java†L9-L88】
- **NumberFormatUtil** — formats abrégés (K/M/B) et arrondis; penser à rendre configurable les suffixes pour des langues différentes. 【F:src/main/java/fr/batistou15/prestigehoe/util/NumberFormatUtil.java†L3-L93】
- **ProtocolLibEffectsUtil** — utilitaire de packets pour effets visuels; dépend de ProtocolLib présent. Ajouter un guard si ProtocolLib est manquant pour éviter les NoClassDefFoundError. 【F:src/main/java/fr/batistou15/prestigehoe/util/ProtocolLibEffectsUtil.java†L7-L113】

## Hoe / Skins / Crops
- **HoeItemManager** — création/validation des hoes, attribution d’owner et skin; centralise la lecture/écriture des meta. Surcharger `updateHoeLore` pour factoriser les duplications lors des upgrades. 【F:src/main/java/fr/batistou15/prestigehoe/hoe/HoeItemManager.java†L16-L267】
- **SkinManager** — charge les définitions de skins et applique les textures. Un cache par id existe; prévoir une validation de doublon d’ID pour éviter les overrides silencieux. 【F:src/main/java/fr/batistou15/prestigehoe/skin/SkinManager.java†L16-L162】
- **SkinDefinition** — POJO décrivant texture/nom/rarity; pourrait implémenter `equals/hashCode` pour faciliter les recherches. 【F:src/main/java/fr/batistou15/prestigehoe/skin/SkinDefinition.java†L5-L54】
- **CropManager** — registre des cultures avec bonus/drops; expose les définitions pour les menus. Ajouter une validation de configuration (matériaux valides, multiplicateurs non négatifs) au chargement. 【F:src/main/java/fr/batistou15/prestigehoe/crop/CropManager.java†L12-L164】
- **CropDefinition** — valeur/XP/commande par culture; avantage d’avoir une factory depuis config pour éviter la dispersion de parsing. 【F:src/main/java/fr/batistou15/prestigehoe/crop/CropDefinition.java†L5-L64】

## Farm / Progression
- **FarmService** — façade qui relie progression, affichage, récompenses et prestige; relancer `reloadConfig()` ne propage rien pour l’instant. Implémentez `Reloadable` et déléguez aux sous-services pour aligner sur les reloads. 【F:src/main/java/fr/batistou15/prestigehoe/farm/FarmService.java†L19-L89】
- **HoeProgressionService** — calcule gain d’xp/niveau, gère prestige reset; s’appuie sur FormulaEngine. Documenter les formules attendues en config pour éviter les erreurs d’expression. 【F:src/main/java/fr/batistou15/prestigehoe/farm/HoeProgressionService.java†L11-L160】
- **RewardFormulaService** — applique les multiplicateurs (fortune, bonus prestige) pour l’argent/essence/tokens; factoriser le code de calcul commun éviterait des divergences. 【F:src/main/java/fr/batistou15/prestigehoe/farm/RewardFormulaService.java†L30-L210】
- **FarmExecutionService** — orchestre la casse de blocs, application des enchants et distribution des récompenses; centraliser les hooks Jobs/Economy/Recap ici assure la cohérence. Vérifier la synchronicité des appels I/O aux profils. 【F:src/main/java/fr/batistou15/prestigehoe/farm/FarmExecutionService.java†L32-L268】
- **HoeDisplayService** — met à jour le lore/placeholder des hoes en fonction des stats; pourrait partager un service de placeholders commun avec MenuPlaceholderService. 【F:src/main/java/fr/batistou15/prestigehoe/farm/HoeDisplayService.java†L19-L152】
- **EnchantUpgradeService** — gère l’achat/vente des niveaux d’enchant, vérifie les coûts et met à jour le profil; ajouter une validation centralisée des caps et des prérequis pour chaque enchant éviterait la duplication. 【F:src/main/java/fr/batistou15/prestigehoe/farm/EnchantUpgradeService.java†L17-L198】
- **PrestigeService** — applique les prestiges et réinitialise la progression; prévoir un hook pour notifier les menus/skins lors d’un prestige pour éviter les désynchronisations. 【F:src/main/java/fr/batistou15/prestigehoe/farm/PrestigeService.java†L16-L136】

## Enchants
- **HoeEnchant** — interface commune (proc, chance, coût, lore). Ajouter une doc sur le contrat de retour (ex: valeurs nulles, probas) clarifierait l’implémentation des enchants custom. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/HoeEnchant.java†L5-L59】
- **EnchantManager** — charge les enchants depuis configs, gère les instances et le random; factoriser le parsing des coûts/conditions aiderait à réduire la complexité. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/EnchantManager.java†L23-L314】
- **EnchantProcHelper** — helpers pour déclencher et logguer les procs (boosters, particles). Uniformiser les logs via EnchantDebugService éviterait la dispersion. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/EnchantProcHelper.java†L14-L194】
- **EnchantDebugService** — trace les activations d’enchants; expose un toggle par joueur. Ajouter un throttle anti-spam serait utile. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/EnchantDebugService.java†L10-L92】
- **ConfigurableCustomProcEnchant** — enchant générique piloté par config avec commandes/particules; utile mais mériterait une validation plus stricte des placeholders et des commandes. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/ConfigurableCustomProcEnchant.java†L52-L195】
- **Enchant implementations** — chaque classe implémente une logique dédiée :
  - **AutosellEnchant**, **FortuneEnchant**, **LineBreakerEnchant** (multi-bloc), **ExplosiveEnchant** (TNT), **SpeedEnchant** (potion), **FuryEnchant** (burst de procs) gèrent des effets immédiats. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/AutosellEnchant.java†L9-L92】【F:src/main/java/fr/batistou15/prestigehoe/enchant/FortuneEnchant.java†L7-L93】【F:src/main/java/fr/batistou15/prestigehoe/enchant/LineBreakerEnchant.java†L24-L212】【F:src/main/java/fr/batistou15/prestigehoe/enchant/ExplosiveEnchant.java†L12-L146】【F:src/main/java/fr/batistou15/prestigehoe/enchant/SpeedEnchant.java†L9-L73】【F:src/main/java/fr/batistou15/prestigehoe/enchant/FuryEnchant.java†L9-L130】
  - **MoneyBoosterEnchant**, **TokenFinderEnchant**, **EssenceBoosterEnchant**, **HoeXpBoosterEnchant**, **PlayerXpBoosterEnchant**, **JobXpBoosterEnchant**, **ProcBoosterEnchant**, **MoneyPouchEnchant**, **EssencePouchEnchant**, **KeyFinderEnchant**, **SpawnerFinderEnchant** appliquent des multiplicateurs ou des récompenses supplémentaires. Harmoniser la gestion des caps et des cooldowns entre ces classes éviterait les incohérences. 【F:src/main/java/fr/batistou15/prestigehoe/enchant/MoneyBoosterEnchant.java†L9-L111】【F:src/main/java/fr/batistou15/prestigehoe/enchant/TokenFinderEnchant.java†L9-L118】【F:src/main/java/fr/batistou15/prestigehoe/enchant/EssenceBoosterEnchant.java†L8-L99】【F:src/main/java/fr/batistou15/prestigehoe/enchant/HoeXpBoosterEnchant.java†L7-L98】【F:src/main/java/fr/batistou15/prestigehoe/enchant/PlayerXpBoosterEnchant.java†L7-L111】【F:src/main/java/fr/batistou15/prestigehoe/enchant/JobXpBoosterEnchant.java†L9-L118】【F:src/main/java/fr/batistou15/prestigehoe/enchant/ProcBoosterEnchant.java†L9-L113】【F:src/main/java/fr/batistou15/prestigehoe/enchant/MoneyPouchEnchant.java†L9-L128】【F:src/main/java/fr/batistou15/prestigehoe/enchant/EssencePouchEnchant.java†L8-L120】【F:src/main/java/fr/batistou15/prestigehoe/enchant/KeyFinderEnchant.java†L9-L109】【F:src/main/java/fr/batistou15/prestigehoe/enchant/SpawnerFinderEnchant.java†L7-L104】

## Menus
- **MenuManager** — charge les menus YAML, résout placeholders et fournit les services associés (Enchant/Skin/Crops/Prestige/Leaderboard). Classe longue (plusieurs inner templates) : séparer les builders par type de menu améliorerait la lisibilité. 【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuManager.java†L18-L1049】
- **MenuListener** / **MenuHolder** / **MenuItemFactory** — support générique pour l’inventaire cliquable; veiller à filtrer les `InventoryClickEvent` par `InventoryHolder` pour éviter les conflits avec d’autres plugins. 【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuListener.java†L11-L177】【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuHolder.java†L9-L39】【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuItemFactory.java†L13-L94】
- **MenuConfig** / **MenuItemConfig** / **MenuIconConfig** — structures de configuration pour les menus; pourraient partager une interface commune pour la désérialisation. 【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuConfig.java†L5-L59】【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuItemConfig.java†L5-L78】【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuIconConfig.java†L3-L34】
- **MenuPlaceholderService** — fournit les remplacements dynamiques pour les items de menu; attention aux accès au cache joueur hors thread principal. 【F:src/main/java/fr/batistou15/prestigehoe/menu/MenuPlaceholderService.java†L17-L152】
- **EnchantMenuService**, **SkinMenuService**, **PrestigeShopMenuService**, **LeaderboardMenuService**, **CropsMenuService** — services dédiés à chaque type de menu; factoriser la construction de l’`Inventory` commun (taille, filler) réduirait le code. 【F:src/main/java/fr/batistou15/prestigehoe/menu/EnchantMenuService.java†L19-L300】【F:src/main/java/fr/batistou15/prestigehoe/menu/SkinMenuService.java†L27-L283】【F:src/main/java/fr/batistou15/prestigehoe/menu/PrestigeShopMenuService.java†L15-L207】【F:src/main/java/fr/batistou15/prestigehoe/menu/LeaderboardMenuService.java†L17-L201】【F:src/main/java/fr/batistou15/prestigehoe/menu/CropsMenuService.java†L22-L175】
- **SkinMenu**, **SkinMenuHolder**, **SkinMenuListener**, **SkullUtil** — composant de sélection de skin; vérifier la pagination et la gestion des têtes asynchrones pour éviter le gel du thread principal. 【F:src/main/java/fr/batistou15/prestigehoe/menu/SkinMenu.java†L25-L211】【F:src/main/java/fr/batistou15/prestigehoe/menu/SkinMenuHolder.java†L7-L38】【F:src/main/java/fr/batistou15/prestigehoe/menu/SkinMenuListener.java†L30-L169】【F:src/main/java/fr/batistou15/prestigehoe/menu/SkullUtil.java†L24-L98】

## Commandes
- **PrestigeHoeCommand** — commande principale avec sous-commandes; utilise un registre statique. Ajouter un système d’autorisations par sous-commande éviterait les duplications. 【F:src/main/java/fr/batistou15/prestigehoe/commands/PrestigeHoeCommand.java†L10-L149】
- **EssenceCommand** — accès rapide aux essences; vérifie les permissions. Penser à supporter l’autocomplétion via tab-complete dynamique. 【F:src/main/java/fr/batistou15/prestigehoe/commands/EssenceCommand.java†L13-L112】
- **AbstractSubCommand** / **SubCommand** — contrat pour les sous-commandes avec nom/usage/permission; pourrait gérer la locale des messages d’erreur. 【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/AbstractSubCommand.java†L12-L76】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/SubCommand.java†L7-L34】
- **Sous-commandes implémentées** — `Help`, `Menu`, `Give`, `Token`, `Essence`, `BoostGive`, `SetOwner`, `SetEnchant`, `SetLevel`, `SetPrestige`, `Reset`, `Perk`, `Info`, `Reload`, `Debug` couvrent l’administration et l’accès joueur. Factoriser les contrôles d’arguments (UUID, nombre) dans AbstractSubCommand réduirait les répétitions. 【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/HelpSubCommand.java†L15-L76】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/MenuSubCommand.java†L9-L83】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/GiveSubCommand.java†L12-L92】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/TokenSubCommand.java†L14-L125】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/EssenceSubCommand.java†L13-L117】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/BoostGiveSubCommand.java†L17-L101】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/SetOwnerSubCommand.java†L19-L101】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/SetEnchantSubCommand.java†L21-L140】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/SetLevelSubCommand.java†L15-L104】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/SetPrestigeSubCommand.java†L13-L105】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/ResetSubCommand.java†L15-L116】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/PerkSubCommand.java†L15-L179】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/InfoSubCommand.java†L17-L142】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/ReloadSubCommand.java†L8-L76】【F:src/main/java/fr/batistou15/prestigehoe/commands/sub/impl/DebugSubCommand.java†L14-L103】

## Listeners
- **PlayerConnectionListener** — charge/sauve les profils à join/quit et donne la hoe initiale; vérifier les sauvegardes asynchrones pour éviter les conflits avec l’auto-save. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/PlayerConnectionListener.java†L13-L156】
- **HoeProtectionListener** — empêche la drop/interaction non voulue de la hoe et ouvre le menu via touche; attention à la compatibilité des touches (F) avec d’autres mods. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/HoeProtectionListener.java†L18-L169】
- **HoeMenuOpenListener** — ouvre les menus depuis la hoe main/off-hand; applique des checks d’owner. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/HoeMenuOpenListener.java†L17-L128】
- **HoeSpeedListener** — ajuste la vitesse de déplacement selon les stats et le prestige; surveiller les stacks de potions pour éviter les effets permanents. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/HoeSpeedListener.java†L19-L153】
- **FarmListener** — capture les événements de farm (block break) pour déléguer à FarmService; considérer un throttling pour limiter les calculs sur les multi-break enchants. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/FarmListener.java†L13-L163】
- **UpgradeMenuListener** — gère les clics dans le menu d’upgrade; partager la logique de validation avec EnchantUpgradeService réduirait les duplications. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/UpgradeMenuListener.java†L16-L83】
- **ExplosiveTntListener** — gère l’explosion TNT déclenchée par l’enchant explosive; veillez à filtrer pour ne toucher que les TNT du plugin. 【F:src/main/java/fr/batistou15/prestigehoe/listeners/ExplosiveTntListener.java†L11-L77】

## Boosts
- **BoostManager** — charge les boosts, suit les boosts actifs et fournit les icônes; plusieurs inner classes dupliquent celles du package (ActiveBoost, BoostDefinition, BoostIconConfig). Garder une seule source de vérité simplifierait le code. 【F:src/main/java/fr/batistou15/prestigehoe/boost/BoostManager.java†L27-L295】
- **BoostUseListener** — applique les boosts lors de l’utilisation d’items; vérifier la consommation unitaire vs stack pour éviter les dupes. 【F:src/main/java/fr/batistou15/prestigehoe/boost/BoostUseListener.java†L11-L101】
- **BoostDefinition**, **BoostIconConfig**, **ActiveBoost** — modèles pour les boosts; fusion possibles avec les inner classes du manager. 【F:src/main/java/fr/batistou15/prestigehoe/boost/BoostDefinition.java†L7-L89】【F:src/main/java/fr/batistou15/prestigehoe/boost/BoostIconConfig.java†L3-L80】【F:src/main/java/fr/batistou15/prestigehoe/boost/ActiveBoost.java†L3-L68】
- **BoostType**, **BoostMode**, **ItemBoostConflictMode** — enums de comportement; documenter l’effet exact de chaque mode dans la config pour éviter les mauvaises surprises. 【F:src/main/java/fr/batistou15/prestigehoe/boost/BoostType.java†L3-L24】【F:src/main/java/fr/batistou15/prestigehoe/boost/BoostMode.java†L3-L29】【F:src/main/java/fr/batistou15/prestigehoe/boost/ItemBoostConflictMode.java†L3-L29】

## Prestige / Leaderboard / Recap / Notification
- **PrestigeBonusService** — calcule les multiplicateurs de prestige/perks; exposer une méthode de refresh lors du reload de prestige.yml éviterait les redémarrages. 【F:src/main/java/fr/batistou15/prestigehoe/prestige/PrestigeBonusService.java†L9-L143】
- **LeaderboardService** — construit les tops depuis les profils; prévoir un cache périodique pour éviter des scans lourds à chaque ouverture de menu. 【F:src/main/java/fr/batistou15/prestigehoe/leaderboard/LeaderboardService.java†L9-L135】
- **RecapService** — suit les gains en session et envoie un récapitulatif; attention à la gestion des sessions pour les joueurs kick/timeout. 【F:src/main/java/fr/batistou15/prestigehoe/recap/RecapService.java†L19-L370】
- **NotificationService** / **NotificationType** — envoie des messages/action-bar/sons configurables; ajouter une file asynchrone éviterait de bloquer sur les sons/packets. 【F:src/main/java/fr/batistou15/prestigehoe/notification/NotificationService.java†L9-L155】【F:src/main/java/fr/batistou15/prestigehoe/notification/NotificationType.java†L5-L28】

## Menus liés aux skins/préstige déjà couverts plus haut

## Divers
- **Protocol hooks et utilitaires** déjà notés; aucun autre package.

## Listeners additionnels
- **HoeMenuOpenListener/ExplosiveTntListener/HoeProtectionListener** déjà couverts ci-dessus; rien à ajouter.

## Observations globales
- Les responsabilités sont souvent dupliquées (Boost classes, gestion des menus) : une consolidation réduirait la maintenance.
- Centraliser le rechargement de config via une interface `Reloadable` pour tous les services (farm, enchants, menus, boosts, prestige) limiterait les incohérences après `/ph reload`.
- Les écritures de profils (JSON/SQL) méritent une sérialisation stricte pour éviter la corruption lors des accès concurrents (auto-save + quit + commandes).
- Les menus et enchants peuvent partager davantage d’utilitaires (placeholders, coût/valeurs) pour éviter les divergences entre classes.

